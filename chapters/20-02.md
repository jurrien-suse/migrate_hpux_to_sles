
## Disk, LVM, and Filesystems (HP LVM/VxFS vs. Linux LVM/Btrfs/Snapper)

### HP LVM vs. Linux LVM2

Linux LVM was originally based on HP-UX LVM, so the concepts map 1:1, but the limitations differ.

| Feature | HP-UX LVM | SLES 16 LVM2 | Critical Difference |
| :---- | :---- | :---- | :---- |
| **Physical Volume** | pvcreate /dev/rdsk/c2t0d0 | pvcreate /dev/sdb | Linux uses block devices, not raw (r) devices for LVM. |
| **Volume Group** | vgcreate vg01 /dev/dsk/c2t0d0 | vgcreate vg01 /dev/sdb |  |
| **Logical Volume** | lvcreate \-L 1000 \-n lvol1 vg01 | lvcreate \-L 1G \-n lvol1 vg01 | Linux accepts human-readable sizes (G, M, T). |
| **Extend** | lvextend \-L 2000 /dev/vg01/lvol1 | lvextend \-L \+1G /dev/vg01/lvol1 | Linux syntax \+1G allows relative extension. |
| **Max Extents** | Rigid max\_pe set at creation. | Virtually unlimited (64-bit). | HP-UX often requires recreating the VG if max\_pe is exceeded. Linux does not.27 |
| **Device Nodes** | /dev/vg01/lvol1 (Character & Block) | /dev/vg01/lvol1 (Symlink to dm device) | Linux uses Device Mapper (/dev/dm-5). |

### The Root Filesystem: Btrfs and Subvolumes

HP-UX 11i v3 defaults to VxFS (Veritas), utilizing Extent-based allocation and intent logging. SLES 16 defaults to **Btrfs** for the root partition.  
**Why Btrfs?**

1. **Copy-on-Write (CoW):** When a file is modified, Btrfs writes the new data to a free block and then updates the metadata pointer. The old data remains until explicitly freed. This enables instant snapshots.  
2. **Bitrot Protection:** Btrfs calculates checksums for data and metadata. If a block is corrupted on disk, Btrfs detects the mismatch on read (unlike VxFS which might silently return corrupted data).

#### Disk Layout & Subvolumes

In HP-UX, /, /usr, /var, and /tmp are usually separate Logical Volumes (LVs). In SLES 16, they are Subvolumes within a single Btrfs partition.

* subvolid=5 (Top Level)  
* @ (Root filesystem, mounted at /)  
* @/var, @/usr/local, @/tmp (Nested subvolumes)  
* **Crucial:** Certain directories like /usr/local, /var/log and /var/lib/pgsql, /var/lib/mysql are created as subvolumes *exempt* from snapshots. This prevents the database or logs from being "rolled back" when the OS is reverted.

### Snapper: Pre/Post Transactional Rollbacks

This is the "killer feature" for the SLES administrator.

* **The Scenario:** You run zypper update to patch glibc and the kernel. The update completes, but upon reboot, the application fails to start due to a library incompatibility.  
* **HP-UX Recovery:** Requires restoring from an Ignite-UX tape or network image, which takes hours. Or, if you were prudent, switching to an alternate boot disk (split mirror), which requires significant pre-planning.  
* **SLES 16 Recovery (Snapper):**  
  1. Zypper automatically triggered a "Pre" snapshot before the update and a "Post" snapshot after.  
  2. Admin reboots into a read-only snapshot via the GRUB2 menu to verify the old state works.  
  3. Admin runs snapper rollback.  
  4. The system makes the "Pre" snapshot the new default boot target.  
  5. Reboot. Total downtime: Minutes.
For just "undoing" configuration changes, which do not require a reboot, there is an even more lightweight method by running "snapper undochange".

For more information on snapper, please use the SUSE Linux Enterprise documentation at (LINK TO BE DONE)

### UEFI and the /boot/efi Partition

HP-UX on Itanium was one of the first OSs to use EFI. SLES 16 on x86-64 mandates UEFI.

* **Requirement:** A dedicated partition (formatted VFAT/FAT32) mounted at /boot/efi.  
* **Sizing:** While HP-UX EFI partitions were often small, SLES 16 recommendations are **512 MB to 1 GB**.  
  * *Reason:* SLES stores the GRUB2 bootloader shim.efi, grubx64.efi, and potentially kernel images here (though usually kernels stay in /boot on XFS/Btrfs). Linux firmware updates (fwupd) also utilize this space. A partition smaller than 256MB will frequently fail during Service Pack upgrades due to lack of space for temporary boot images.32  
* **Partition Table:** Must be GPT (GUID Partition Table). The legacy MBR (Master Boot Record) is not supported for the boot drive in default SLES 16 UEFI installations.

### Architectural Deep Dive: HP LVM vs. Linux LVM2

While Linux LVM was originally inspired by HP-UX LVM, the implementations have diverged significantly. For the HP-UX administrator, the command syntax is familiar, but the underlying mechanisms for metadata, device nodes, and allocation policies are fundamentally different.

#### The "Group File" vs. Udev and Device Mapper

In HP-UX, the Volume Group (VG) requires a character device file (the "group file") to communicate with the kernel.

* **HP-UX Legacy Workflow:**  
  1. mkdir /dev/vg01  
  2. mknod /dev/vg01/group c 64 0x010000 (Manual creation of major/minor numbers).  
  3. vgcreate /dev/vg01...  
* SLES 16 Architecture:  
  Linux uses udev and the Device Mapper kernel framework. There is no concept of a "group file" or manual major/minor number assignment for VGs.  
  1. vgcreate vg01 /dev/sdb  
  2. The kernel automatically assigns a dynamic minor number.  
  3. udev automatically creates the device nodes in /dev/vg01/ and /dev/mapper/.  
  * **Educational Note:** In Linux, /dev/vg01/lvol1 is merely a symbolic link to /dev/dm-X. The real block device is managed by the device mapper.

#### Metadata: Binary VGRA vs. Text-Based LVM2

* **HP-UX:** Uses binary structures like the **VGRA** (Volume Group Reserved Area) and **VGDA** (Volume Group Descriptor Area). If these headers are corrupted, specialized binary tools (or dd wizardry) are required to recover them.  
* **SLES 16 (LVM2):** Uses a **Text-Based Metadata** format.  
  * *Feature:* The metadata stored on the disk (typically in the first 1MB) is a human-readable ASCII configuration.  
  * *Recovery:* SLES keeps automatic backups of this text metadata in /etc/lvm/archive/. If a PV header is wiped, an administrator can literally cat the backup file to find the UUIDs and extent maps, then restore it using vgcfgrestore.

#### Allocation Policies and "Strict" Mirroring

* **HP-UX:** Admins often rely on **PVG-Strict** (Physical Volume Group) mirroring to ensure mirrors sit on separate hardware controllers.  
* **SLES 16:** Linux LVM does not use "PV Groups" in the same way. Instead, it uses allocation policies:  
  * \--alloc contiguous: Enforces sequential blocks.  
  * \--alloc cling: Prefers keeping data on the same PV.  
  * \--mirrors 1: By default, LVM attempts "strict" allocation (allocating the mirror leg on a different PV). To replicate complex PVG-strict logic, SLES admins use **Tags** on Physical Volumes or explicitly specify PVs during creation (lvcreate... /dev/sda /dev/sdb).

#### Bad Block Relocation (BBR)

* **HP-UX:** LVM historically handled Bad Block Relocation (lvcreate \-r y).  
* **SLES 16:** Linux LVM **does not** perform software-based bad block relocation. The philosophy is that modern storage arrays and drive firmware handle sector remapping transparently. If a drive presents a bad block to the OS, the filesystem (Btrfs) or the hardware RAID controller is expected to handle it, not the Volume Manager.




